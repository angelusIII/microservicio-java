name: CI

on:  
 push:
 workflow_dispatch:
 
jobs:  
 build:
   
  runs-on: ubuntu-latest  
  steps:
   
   - uses: actions/checkout@v3 
   
   - name: Build
     run: |
       chmod +x gradlew
       ./gradlew build
       ls -ltra
       
   - name: Generate Jacoco Coverage Report
     run: |
       chmod +x gradlew
       ./gradlew jacocoTestReport
       
   - name: SonarCluod Analysis
     run: |
       chmod +x gradlew
       ./gradlew build sonar -Dsonar.token=${{ secrets.SONARCLOUD_TOKEN }}
       
   - name: SonarQube Quality Gate Check
     uses: sonarsource/sonarqube-quality-gate-action@master
     env: 
       SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
       SONAR_HOST_URL: https://sonarcloud.io
       SONAR_QUALITYGATE: 'Cobertura'
       wait-for-quality-gate: true
     with: 
       scanMetadataReportFile: build/sonar/report-task.txt

   - name: Docker Login
     uses: docker/login-action@v2.2.0
     with: 
       username: ${{ secrets.DOCKER_USERNAME }}
       password: ${{ secrets.DOCKER_PASSWORD }}
